name: Build Multi-Platform & Multi-Architecture Executable

on:
  push:
    branches: [ main ]
    tags:
      - "v*"
  pull_request:
    branches: [ main ]

jobs:
  # --- BUILDS LINUX ---
  build-linux-x86:
    name: "Build for Linux (x86_64)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: "Compiler pour Linux x86_64 (Ubuntu 20.04, Python 3.8)"
        run: |
          docker run --rm -v "$(pwd)":/app -w /app ubuntu:20.04 bash -lc "
            set -euo pipefail
            apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
              python3 python3-pip python3-tk libpython3.8 binutils patchelf wget ca-certificates \
              file desktop-file-utils squashfs-tools
            python3 -m pip install --upgrade pip wheel
            python3 -m pip install -r requirements.txt pyinstaller
            python3 -m PyInstaller --noconsole --onefile --name liff-viewer \
              --add-data 'ico/app.png:ico' --add-data 'ico/app.ico:ico' --hidden-import=PIL._tkinter_finder \
              main.py

            echo '== Génération AppImage x86_64 =='
            cd dist
            mkdir -p AppDir/usr/bin AppDir/usr/share/icons/hicolor/256x256/apps
            cp liff-viewer AppDir/usr/bin/
            cp ../ico/app.png AppDir/usr/share/icons/hicolor/256x256/apps/liff-viewer.png
            cp ../ico/app.png AppDir/liff-viewer.png

          printf '%s\n' \
            '[Desktop Entry]' \
            'Type=Application' \
            'Name=LIFF Viewer' \
            'Exec=liff-viewer' \
            'Icon=liff-viewer' \
            'Categories=Graphics;' \
            'Terminal=false' \
            'StartupWMClass=liff-viewer' > AppDir/liff-viewer.desktop

            printf '%s\n' \
              '#!/bin/sh' \
              'HERE=\"$(dirname \"$(readlink -f \"$0\")\")\"' \
              'export PATH=\"$HERE/usr/bin:$PATH\"' \
              'exec liff-viewer \"$@\"' > AppDir/AppRun
            chmod +x AppDir/AppRun AppDir/usr/bin/liff-viewer

            wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
            chmod +x appimagetool-x86_64.AppImage
            ARCH=x86_64 APPIMAGE_EXTRACT_AND_RUN=1 ./appimagetool-x86_64.AppImage AppDir liff-viewer-x86_64.AppImage

            echo '== Contenu dist =='
            ls -lah
            test -f liff-viewer-x86_64.AppImage || { echo 'AppImage manquante'; exit 1; }

            # Rendre la sortie au user hôte
            HOST_UID=$(stat -c '%u' /app); HOST_GID=$(stat -c '%g' /app)
            chown -R \"$HOST_UID:$HOST_GID\" /app/dist || true
          "
      - uses: actions/upload-artifact@v4
        with:
          name: liff-viewer_linux_x86_64
          path: dist/liff-viewer
      - uses: actions/upload-artifact@v4
        with:
          name: liff-viewer_linux_x86_64_appimage
          path: dist/liff-viewer-x86_64.AppImage

  build-linux-arm:
    name: "Build for Linux (ARM64)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - name: "Compiler pour Linux ARM64 (Ubuntu 20.04, Python 3.8) — prépare AppDir uniquement"
        run: |
          docker run --platform linux/arm64 --rm -v "$(pwd)":/app -w /app arm64v8/ubuntu:20.04 bash -lc "
            set -euo pipefail
            apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
              python3 python3-pip python3-tk libpython3.8 binutils patchelf wget ca-certificates \
              file desktop-file-utils squashfs-tools
            python3 -m pip install --upgrade pip wheel
            python3 -m pip install -r requirements.txt pyinstaller
            python3 -m PyInstaller --noconsole --onefile --name liff-viewer \
              --add-data 'ico/app.png:ico' --add-data 'ico/app.ico:ico' --hidden-import=PIL._tkinter_finder \
              main.py

            echo '== Préparation AppDir aarch64 (pas de packaging ici) =='
            cd dist
            mkdir -p AppDir/usr/bin AppDir/usr/share/icons/hicolor/256x256/apps
            cp liff-viewer AppDir/usr/bin/
            cp ../ico/app.png AppDir/usr/share/icons/hicolor/256x256/apps/liff-viewer.png
            cp ../ico/app.png AppDir/liff-viewer.png

          printf '%s\n' \
            '[Desktop Entry]' \
            'Type=Application' \
            'Name=LIFF Viewer' \
            'Exec=liff-viewer' \
            'Icon=liff-viewer' \
            'Categories=Graphics;' \
            'Terminal=false' \
            'StartupWMClass=liff-viewer' > AppDir/liff-viewer.desktop

            printf '%s\n' \
              '#!/bin/sh' \
              'HERE=\"$(dirname \"$(readlink -f \"$0\")\")\"' \
              'export PATH=\"$HERE/usr/bin:$PATH\"' \
              'exec liff-viewer \"$@\"' > AppDir/AppRun
            chmod +x AppDir/AppRun AppDir/usr/bin/liff-viewer

            echo '== AppDir prêt =='
            find AppDir -maxdepth 2 -type f -ls

            # Rendre la sortie au user hôte
            HOST_UID=$(stat -c '%u' /app); HOST_GID=$(stat -c '%g' /app)
            chown -R \"$HOST_UID:$HOST_GID\" /app/dist || true
          "
      - name: "Packager l’AppImage ARM64 sur l’hôte x86_64"
        shell: bash
        run: |
          set -euo pipefail

          # deps pour appimagetool (hôte x86_64)
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends squashfs-tools file desktop-file-utils wget

          echo "== Vérification de la sortie du build ARM =="
          ls -lah
          ls -lah dist || true
          find dist -maxdepth 2 -type f -print || true
          find dist -maxdepth 3 -type d -print || true

          # *** FIX PERMISSIONS (nouvelle ligne) ***
          sudo chown -R $(id -u):$(id -g) dist

          # S'assurer que AppRun/exe sont utilisables
          chmod +x dist/AppDir/AppRun || true
          chmod +x dist/AppDir/usr/bin/liff-viewer || true

          # Optionnel : valider le .desktop
          if command -v desktop-file-validate >/dev/null 2>&1; then
            echo "== Validation du .desktop =="
            desktop-file-validate dist/AppDir/liff-viewer.desktop || true
          fi

          cd dist
          echo "== Packaging AppImage aarch64 =="
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          ARCH=aarch64 APPIMAGE_EXTRACT_AND_RUN=1 ./appimagetool-x86_64.AppImage AppDir liff-viewer-aarch64.AppImage

          echo "== Contenu dist =="
          ls -lah
          test -f liff-viewer-aarch64.AppImage || { echo "::error::AppImage ARM manquante"; exit 1; }

      - uses: actions/upload-artifact@v4
        with:
          name: liff-viewer_linux_arm64
          path: dist/liff-viewer
      - uses: actions/upload-artifact@v4
        with:
          name: liff-viewer_linux_arm64_appimage
          path: dist/liff-viewer-aarch64.AppImage

  # --- BUILDS WINDOWS ---
  build-windows-x86:
    name: "Build for Windows (x86_64)"
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10.11"
          cache: pip
      - run: pip install -r requirements.txt
      - run: pyinstaller --noconsole --onefile --name liff-viewer --icon=ico/app.ico --add-data "ico/app.ico;ico" --add-data "ico/app.png;ico" --hidden-import=PIL._tkinter_finder main.py
      - uses: actions/upload-artifact@v4
        with:
          name: liff-viewer_windows_x86_64
          path: dist/liff-viewer.exe

  build-windows-arm:
    name: "Build for Windows (ARM64)"
    runs-on: windows-11-arm
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11.5"
          cache: pip
      - run: pip install -r requirements.txt
      - run: pyinstaller --noconsole --onefile --name liff-viewer --icon=ico/app.ico --add-data "ico/app.ico;ico" --add-data "ico/app.png;ico" --hidden-import=PIL._tkinter_finder main.py
      - uses: actions/upload-artifact@v4
        with:
          name: liff-viewer_windows_arm64
          path: dist/liff-viewer.exe
          
  # --- BUILDS MACOS ---
  build-macos-arm64:
    name: "Build for macOS (ARM64)"
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10.11"
          cache: pip
      - name: "Installer les dépendances"
        run: pip install -r requirements.txt
      - name: "Créer le fichier .icns à partir du PNG"
        run: |
          mkdir -p app.iconset
          sips -z 16 16 ico/app.png --out app.iconset/icon_16x16.png
          sips -z 32 32 ico/app.png --out app.iconset/icon_16x16@2x.png
          sips -z 32 32 ico/app.png --out app.iconset/icon_32x32.png
          sips -z 64 64 ico/app.png --out app.iconset/icon_32x32@2x.png
          sips -z 128 128 ico/app.png --out app.iconset/icon_128x128.png
          sips -z 256 256 ico/app.png --out app.iconset/icon_128x128@2x.png
          iconutil -c icns app.iconset -o ico/app.icns
      - name: "PyInstaller (ARM64)"
        run: |
          pyinstaller \
            --noconsole --windowed --onefile --name liff-viewer --icon=ico/app.icns \
            --add-data "ico/app.png:ico" --add-data 'ico/app.ico:ico' --hidden-import=PIL._tkinter_finder \
            --target-arch arm64 main.py
      - uses: actions/upload-artifact@v4
        with:
          name: liff-viewer_macos_arm64
          path: dist/liff-viewer

  build-macos-x86_64:
    name: "Build for macOS (Intel x86_64)"
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10.11"
          cache: pip
      - name: "Installer les dépendances"
        run: pip install -r requirements.txt
      - name: "Créer le fichier .icns à partir du PNG"
        run: |
          mkdir -p app.iconset
          sips -z 16 16 ico/app.png --out app.iconset/icon_16x16.png
          sips -z 32 32 ico/app.png --out app.iconset/icon_16x16@2x.png
          sips -z 32 32 ico/app.png --out app.iconset/icon_32x32.png
          sips -z 64 64 ico/app.png --out app.iconset/icon_32x32@2x.png
          sips -z 128 128 ico/app.png --out app.iconset/icon_128x128.png
          sips -z 256 256 ico/app.png --out app.iconset/icon_128x128@2x.png
          iconutil -c icns app.iconset -o ico/app.icns
      - name: "PyInstaller (x86_64)"
        run: |
          pyinstaller \
            --noconsole --windowed --onefile --name liff-viewer --icon=ico/app.icns \
            --add-data "ico/app.png:ico" --add-data 'ico/app.ico:ico' --hidden-import=PIL._tkinter_finder \
            --target-arch x86_64 main.py
      - uses: actions/upload-artifact@v4
        with:
          name: liff-viewer_macos_x86_64
          path: dist/liff-viewer

  # --- RELEASE ---
  release:
    name: "Publish GitHub Release"
    runs-on: ubuntu-latest
    needs:
      - build-linux-x86
      - build-linux-arm
      - build-windows-x86
      - build-windows-arm
      - build-macos-arm64
      - build-macos-x86_64
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_assets

      - name: Renommer les assets avec des noms uniques
        run: |
          set -euo pipefail
          mkdir -p to_release

          cp "release_assets/liff-viewer_linux_x86_64/liff-viewer"                    "to_release/liff-viewer-linux-x86_64"
          cp "release_assets/liff-viewer_linux_x86_64_appimage/liff-viewer-x86_64.AppImage" "to_release/liff-viewer-x86_64.AppImage"

          cp "release_assets/liff-viewer_linux_arm64/liff-viewer"                     "to_release/liff-viewer-linux-aarch64"
          cp "release_assets/liff-viewer_linux_arm64_appimage/liff-viewer-aarch64.AppImage" "to_release/liff-viewer-aarch64.AppImage"

          cp "release_assets/liff-viewer_windows_x86_64/liff-viewer.exe"              "to_release/liff-viewer-windows-x86_64.exe"
          cp "release_assets/liff-viewer_windows_arm64/liff-viewer.exe"               "to_release/liff-viewer-windows-arm64.exe"

          cp "release_assets/liff-viewer_macos_arm64/liff-viewer"                     "to_release/liff-viewer-macos-arm64"
          cp "release_assets/liff-viewer_macos_x86_64/liff-viewer"                    "to_release/liff-viewer-macos-x86_64"

          echo "== Liste finale =="
          ls -lah to_release

      - name: Create Release (tag push -> public; sinon -> draft nightly)
        uses: softprops/action-gh-release@v2
        with:
          files: to_release/*
          draft: ${{ !startsWith(github.ref, 'refs/tags/') }}
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && '' || format('nightly-{0}', github.run_number) }}
          name: ${{ startsWith(github.ref, 'refs/tags/') && '' || format('Nightly {0}', github.run_number) }}
          body: ${{ startsWith(github.ref, 'refs/tags/') && '' || 'Build automatique depuis main.' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
