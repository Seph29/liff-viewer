name: Build Multi-Platform & Multi-Architecture Executable

on:
  push:
    branches: [ main ]
    tags:
      - "v*"
  pull_request:
    branches: [ main ]

jobs:
  # --- BUILDS LINUX ---
  build-linux-x86:
    name: "Build for Linux (x86_64)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: "Compiler pour Linux x86_64 (Ubuntu 20.04, Python 3.8)"
        run: |
          docker run --rm -v "$(pwd)":/app -w /app ubuntu:20.04 bash -lc "
            set -euo pipefail
            apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
              python3 python3-pip python3-tk libpython3.8 binutils patchelf wget ca-certificates
            python3 -m pip install --upgrade pip wheel
            python3 -m pip install -r requirements.txt pyinstaller
            python3 -m PyInstaller --noconsole --onefile --name liff-viewer \
              --add-data 'ico/app.png:ico' --hidden-import=PIL._tkinter_finder \
              main.py

            echo '== Génération AppImage x86_64 =='
            cd dist
            mkdir -p AppDir/usr/bin AppDir/usr/share/icons/hicolor/256x256/apps
            cp liff-viewer AppDir/usr/bin/
            cp ../ico/app.png AppDir/usr/share/icons/hicolor/256x256/apps/liff-viewer.png
            cp ../ico/app.png AppDir/liff-viewer.png

            # .desktop sans heredoc
            printf '%s\n' \
              '[Desktop Entry]' \
              'Type=Application' \
              'Name=LIFF Viewer' \
              'Exec=liff-viewer' \
              'Icon=liff-viewer' \
              'Categories=Graphics;' \
              'Terminal=false' > AppDir/liff-viewer.desktop

            # AppRun sans heredoc
            printf '%s\n' \
              '#!/bin/sh' \
              'HERE="$(dirname "$(readlink -f "$0")")"' \
              'export PATH="$HERE/usr/bin:$PATH"' \
              'exec liff-viewer "$@"' > AppDir/AppRun
            chmod +x AppDir/AppRun AppDir/usr/bin/liff-viewer

            wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
            chmod +x appimagetool-x86_64.AppImage
            ARCH=x86_64 APPIMAGE_EXTRACT_AND_RUN=1 ./appimagetool-x86_64.AppImage AppDir liff-viewer-x86_64.AppImage

            echo '== Contenu dist =='
            ls -lah
            test -f liff-viewer-x86_64.AppImage || { echo 'AppImage manquante'; exit 1; }
          "
      - uses: actions/upload-artifact@v4
        with:
          name: liff-viewer_linux_x86_64
          path: dist/liff-viewer
      - uses: actions/upload-artifact@v4
        with:
          name: liff-viewer_linux_x86_64_appimage
          path: dist/liff-viewer-x86_64.AppImage

  build-linux-arm:
    name: "Build for Linux (ARM64)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - name: "Compiler pour Linux ARM64 (Ubuntu 20.04, Python 3.8)"
        run: |
          docker run --platform linux/arm64 --rm -v "$(pwd)":/app -w /app arm64v8/ubuntu:20.04 bash -lc "
            set -euo pipefail
            apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
              python3 python3-pip python3-tk libpython3.8 binutils patchelf wget ca-certificates
            python3 -m pip install --upgrade pip wheel
            python3 -m pip install -r requirements.txt pyinstaller
            python3 -m PyInstaller --noconsole --onefile --name liff-viewer \
              --add-data 'ico/app.png:ico' --hidden-import=PIL._tkinter_finder \
              main.py

            echo '== Génération AppImage aarch64 =='
            cd dist
            mkdir -p AppDir/usr/bin AppDir/usr/share/icons/hicolor/256x256/apps
            cp liff-viewer AppDir/usr/bin/
            cp ../ico/app.png AppDir/usr/share/icons/hicolor/256x256/apps/liff-viewer.png
            cp ../ico/app.png AppDir/liff-viewer.png

            printf '%s\n' \
              '[Desktop Entry]' \
              'Type=Application' \
              'Name=LIFF Viewer' \
              'Exec=liff-viewer' \
              'Icon=liff-viewer' \
              'Categories=Graphics;' \
              'Terminal=false' > AppDir/liff-viewer.desktop

            printf '%s\n' \
              '#!/bin/sh' \
              'HERE="$(dirname "$(readlink -f "$0")")"' \
              'export PATH="$HERE/usr/bin:$PATH"' \
              'exec liff-viewer "$@"' > AppDir/AppRun
            chmod +x AppDir/AppRun AppDir/usr/bin/liff-viewer

            wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-aarch64.AppImage
            chmod +x appimagetool-aarch64.AppImage
            ARCH=aarch64 APPIMAGE_EXTRACT_AND_RUN=1 ./appimagetool-aarch64.AppImage AppDir liff-viewer-aarch64.AppImage

            echo '== Contenu dist =='
            ls -lah
            test -f liff-viewer-aarch64.AppImage || { echo 'AppImage manquante'; exit 1; }
          "
      - uses: actions/upload-artifact@v4
        with:
          name: liff-viewer_linux_arm64
          path: dist/liff-viewer
      - uses: actions/upload-artifact@v4
        with:
          name: liff-viewer_linux_arm64_appimage
          path: dist/liff-viewer-aarch64.AppImage

  # --- BUILDS WINDOWS ---
  build-windows-x86:
    name: "Build for Windows (x86_64)"
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10.11"
          cache: pip
      - run: pip install -r requirements.txt
      - run: pyinstaller --noconsole --onefile --name liff-viewer --icon=ico/app.ico --add-data "ico/app.png;ico" --hidden-import=PIL._tkinter_finder main.py
      - uses: actions/upload-artifact@v4
        with:
          name: liff-viewer_windows_x86_64
          path: dist/liff-viewer.exe

  build-windows-arm:
    name: "Build for Windows (ARM64)"
    runs-on: windows-11-arm
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11.5"
          cache: pip
      - run: pip install -r requirements.txt
      - run: pyinstaller --noconsole --onefile --name liff-viewer --icon=ico/app.ico --add-data "ico/app.png;ico" --hidden-import=PIL._tkinter_finder main.py
      - uses: actions/upload-artifact@v4
        with:
          name: liff-viewer_windows_arm64
          path: dist/liff-viewer.exe
          
  # --- BUILDS MACOS (deux jobs: ARM64 et Intel x86_64) ---
  build-macos-arm64:
    name: "Build for macOS (ARM64)"
    runs-on: macos-latest  # Apple Silicon
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10.11"
          cache: pip
      - name: "Installer les dépendances"
        run: pip install -r requirements.txt
      - name: "Créer le fichier .icns à partir du PNG"
        run: |
          mkdir -p app.iconset
          sips -z 16 16 ico/app.png --out app.iconset/icon_16x16.png
          sips -z 32 32 ico/app.png --out app.iconset/icon_16x16@2x.png
          sips -z 32 32 ico/app.png --out app.iconset/icon_32x32.png
          sips -z 64 64 ico/app.png --out app.iconset/icon_32x32@2x.png
          sips -z 128 128 ico/app.png --out app.iconset/icon_128x128.png
          sips -z 256 256 ico/app.png --out app.iconset/icon_128x128@2x.png
          iconutil -c icns app.iconset -o ico/app.icns
      - name: "PyInstaller (ARM64)"
        run: |
          pyinstaller \
            --noconsole --windowed --onefile --name liff-viewer --icon=ico/app.icns \
            --add-data "ico/app.png:ico" --hidden-import=PIL._tkinter_finder \
            --target-arch arm64 main.py
      - uses: actions/upload-artifact@v4
        with:
          name: liff-viewer_macos_arm64
          path: dist/liff-viewer

  build-macos-x86_64:
    name: "Build for macOS (Intel x86_64)"
    runs-on: macos-15-intel  # Runner Intel
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10.11"
          cache: pip
      - name: "Installer les dépendances"
        run: pip install -r requirements.txt
      - name: "Créer le fichier .icns à partir du PNG"
        run: |
          mkdir -p app.iconset
          sips -z 16 16 ico/app.png --out app.iconset/icon_16x16.png
          sips -z 32 32 ico/app.png --out app.iconset/icon_16x16@2x.png
          sips -z 32 32 ico/app.png --out app.iconset/icon_32x32.png
          sips -z 64 64 ico/app.png --out app.iconset/icon_32x32@2x.png
          sips -z 128 128 ico/app.png --out app.iconset/icon_128x128.png
          sips -z 256 256 ico/app.png --out app.iconset/icon_128x128@2x.png
          iconutil -c icns app.iconset -o ico/app.icns
      - name: "PyInstaller (x86_64)"
        run: |
          pyinstaller \
            --noconsole --windowed --onefile --name liff-viewer --icon=ico/app.icns \
            --add-data "ico/app.png:ico" --hidden-import=PIL._tkinter_finder \
            --target-arch x86_64 main.py
      - uses: actions/upload-artifact@v4
        with:
          name: liff-viewer_macos_x86_64
          path: dist/liff-viewer

  # --- RELEASE ---
  release:
    name: "Publish GitHub Release"
    runs-on: ubuntu-latest
    needs:
      - build-linux-x86
      - build-linux-arm
      - build-windows-x86
      - build-windows-arm
      - build-macos-arm64
      - build-macos-x86_64
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_assets

      - name: Create Release (tag push -> public; sinon -> draft nightly)
        uses: softprops/action-gh-release@v2
        with:
          files: release_assets/**/*
          draft: ${{ !startsWith(github.ref, 'refs/tags/') }}
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && '' || format('nightly-{0}', github.run_number) }}
          name: ${{ startsWith(github.ref, 'refs/tags/') && '' || format('Nightly {0}', github.run_number) }}
          body: ${{ startsWith(github.ref, 'refs/tags/') && '' || 'Build automatique depuis main.' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
